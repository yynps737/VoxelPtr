name: Publish Mod

on:
  push:
    tags:
      - 'v*'

env:
  JAVA_VERSION: 21

jobs:
  build:
    name: Build and Publish
    runs-on: ubuntu-latest

    permissions:
      contents: write  # éœ€è¦å†™å…¥æƒé™æ¥åˆ›å»º Release

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout Repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Java ç¯å¢ƒ
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      # 3. èµ‹äºˆ Gradle æ‰§è¡Œæƒé™
      - name: Grant Execute Permission for Gradle
        run: chmod +x gradlew

      # 4. æ„å»º Mod
      - name: Build with Gradle
        run: ./gradlew build

      # 5. è·å–ç‰ˆæœ¬ä¿¡æ¯
      - name: Get Version from Tag
        id: version
        run: |
          # ç§»é™¤ 'v' å‰ç¼€ï¼Œä¾‹å¦‚ v1.0.0 -> 1.0.0
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "minecraft=1.20.2" >> $GITHUB_OUTPUT

          # è·å– JAR æ–‡ä»¶å
          JAR_FILE=$(ls build/libs/ | grep -v sources | grep .jar$ | head -n 1)
          echo "jar_file=build/libs/$JAR_FILE" >> $GITHUB_OUTPUT
          echo "jar_name=$JAR_FILE" >> $GITHUB_OUTPUT

      # 6. è¯»å– CHANGELOG
      - name: Extract Changelog
        id: changelog
        run: |
          # æå–å½“å‰ç‰ˆæœ¬çš„ CHANGELOG
          VERSION=${{ steps.version.outputs.version }}
          CHANGELOG=$(awk "/## \[$VERSION\]/,/## \[/" CHANGELOG.md | sed '/## \[/d' | sed '/^$/d')

          # è½¬ä¹‰ç‰¹æ®Šå­—ç¬¦å¹¶ä¿å­˜
          CHANGELOG="${CHANGELOG//'%'/'%25'}"
          CHANGELOG="${CHANGELOG//$'\n'/'%0A'}"
          CHANGELOG="${CHANGELOG//$'\r'/'%0D'}"
          echo "content=$CHANGELOG" >> $GITHUB_OUTPUT

      # 7. å‘å¸ƒåˆ° Modrinth (ä¸»è¦å¹³å°)
      - name: Publish to Modrinth
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          modrinth-id: ${{ secrets.MODRINTH_PROJECT_ID }}
          modrinth-token: ${{ secrets.MODRINTH_TOKEN }}

          files: ${{ steps.version.outputs.jar_file }}
          name: VoxelPtr v${{ steps.version.outputs.version }}
          version: ${{ steps.version.outputs.version }}
          version-type: release

          loaders: fabric
          game-versions: |
            1.20.2

          dependencies: |
            fabric-api | depends | *
            modmenu | recommends | *

          changelog: ${{ steps.changelog.outputs.content }}

      # 8. å‘å¸ƒåˆ° CurseForge
      - name: Publish to CurseForge
        uses: Kir-Antipov/mc-publish@v3.3
        with:
          curseforge-id: ${{ secrets.CURSEFORGE_PROJECT_ID }}
          curseforge-token: ${{ secrets.CURSEFORGE_TOKEN }}

          files: ${{ steps.version.outputs.jar_file }}
          name: VoxelPtr v${{ steps.version.outputs.version }}
          version: ${{ steps.version.outputs.version }}
          version-type: release

          loaders: fabric
          game-versions: |
            1.20.2

          dependencies: |
            fabric-api | required
            modmenu | optional

          changelog: ${{ steps.changelog.outputs.content }}

      # 9. åˆ›å»º GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: ${{ steps.version.outputs.jar_file }}
          body: |
            # VoxelPtr v${{ steps.version.outputs.version }}

            é«˜æ€§èƒ½ Minecraft çŸ¿çŸ³è¿½è¸ªæ¨¡ç»„ - ä¸º Minecraft ${{ steps.version.outputs.minecraft }} æ„å»º

            ## ğŸ“¥ ä¸‹è½½

            - **Modrinth**: https://modrinth.com/mod/voxelptr

            ## ğŸ“ æ›´æ–°æ—¥å¿—

            ${{ steps.changelog.outputs.content }}

            ## ğŸ“¦ å®‰è£…æ–¹æ³•

            1. å®‰è£… [Fabric Loader](https://fabricmc.net/use/)
            2. ä¸‹è½½ [Fabric API](https://modrinth.com/mod/fabric-api)
            3. ä¸‹è½½ VoxelPtr å¹¶æ”¾å…¥ `mods` æ–‡ä»¶å¤¹
            4. å¯åŠ¨æ¸¸æˆ

            ## ğŸ® ä½¿ç”¨è¯´æ˜

            - æŒ‰ `V` é”®å¯ç”¨/ç¦ç”¨åŠŸèƒ½
            - æŒ‰ `N` é”®åˆ‡æ¢çŸ¿ç‰©é¢„è®¾
            - åœ¨é…ç½®èœå•ä¸­è‡ªå®šä¹‰è®¾ç½®

            ---

            **æ”¯æŒçš„ Minecraft ç‰ˆæœ¬**: ${{ steps.version.outputs.minecraft }}
            **éœ€è¦ Fabric API**: æ˜¯
            **æ€§èƒ½æå‡**: 50-70% ğŸš€
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 10. å‘é€ Discord é€šçŸ¥
      - name: Send Discord Notification
        if: success()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          VERSION=${{ steps.version.outputs.version }}
          MINECRAFT=${{ steps.version.outputs.minecraft }}
          JAR_NAME=${{ steps.version.outputs.jar_name }}

          # åˆ›å»º Discord Embed æ¶ˆæ¯
          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "ğŸ‰ VoxelPtr v'"$VERSION"' å·²å‘å¸ƒï¼",
                "description": "æ–°ç‰ˆæœ¬å·²æˆåŠŸå‘å¸ƒåˆ°æ‰€æœ‰å¹³å°",
                "color": 5814783,
                "fields": [
                  {
                    "name": "ğŸ“¦ ç‰ˆæœ¬",
                    "value": "v'"$VERSION"'",
                    "inline": true
                  },
                  {
                    "name": "ğŸ® Minecraft",
                    "value": "'"$MINECRAFT"'",
                    "inline": true
                  },
                  {
                    "name": "âš¡ æ€§èƒ½æå‡",
                    "value": "50-70%",
                    "inline": true
                  },
                  {
                    "name": "ğŸ“¥ ä¸‹è½½é“¾æ¥",
                    "value": "[Modrinth](https://modrinth.com/mod/voxelptr) | [CurseForge](https://www.curseforge.com/minecraft/mc-mods/voxelptr) | [GitHub](https://github.com/'"$GITHUB_REPOSITORY"'/releases/tag/v'"$VERSION"')"
                  },
                  {
                    "name": "âœ¨ ä¸»è¦ç‰¹æ€§",
                    "value": "â€¢ å®æ—¶çŸ¿çŸ³æ‰«æ\nâ€¢ 10ç§çŸ¿ç‰©é¢„è®¾\nâ€¢ æ–¹å‘æŒ‡ç¤ºç³»ç»Ÿ\nâ€¢ é«˜åº¦å¯é…ç½®"
                  }
                ],
                "footer": {
                  "text": "VoxelPtr - é«˜æ€§èƒ½çŸ¿çŸ³è¿½è¸ª"
                },
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "$DISCORD_WEBHOOK"

      # 11. å¤±è´¥é€šçŸ¥
      - name: Send Discord Failure Notification
        if: failure()
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
        run: |
          VERSION=${{ steps.version.outputs.version }}

          curl -H "Content-Type: application/json" \
            -d '{
              "embeds": [{
                "title": "âŒ å‘å¸ƒå¤±è´¥",
                "description": "VoxelPtr v'"$VERSION"' å‘å¸ƒè¿‡ç¨‹ä¸­å‡ºç°é”™è¯¯",
                "color": 16711680,
                "fields": [
                  {
                    "name": "æŸ¥çœ‹è¯¦æƒ…",
                    "value": "[GitHub Actions](https://github.com/'"$GITHUB_REPOSITORY"'/actions/runs/'"$GITHUB_RUN_ID"')"
                  }
                ],
                "timestamp": "'"$(date -u +%Y-%m-%dT%H:%M:%S.000Z)"'"
              }]
            }' \
            "$DISCORD_WEBHOOK"
